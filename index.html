<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGE - Sistema Integrado de Gestão Paroquial</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <script>
        (async function () {
            try {
                const stored = localStorage.getItem('sige_user');
                if (!stored) {
                    window.location.href = 'login.html';
                    return;
                }
                const user = JSON.parse(stored);
                const resp = await fetch('http://localhost:3001/api/auth/boot');
                if (!resp.ok) throw new Error('boot request failed');
                const body = await resp.json();
                if (!body.bootId || user.bootId !== body.bootId) {
                    localStorage.removeItem('sige_user');
                    window.location.href = 'login.html';
                }
            } catch (err) {
                console.error('Falha ao validar sessão:', err);
                localStorage.removeItem('sige_user');
                window.location.href = 'login.html';
            }
        })();
    </script>
    <div class="app-container">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar">
            <!-- Header -->
            <div class="sidebar-header">
                <div id="sidebar-header" class="logo-container">
                    <div class="logo-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </div>
                    <div class="logo-text">
                        <h1>SIGE</h1>
                        <p>Sistema Paroquial</p>
                    </div>
                </div>
                <button onclick="toggleSidebar()" class="toggle-btn">
                    <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <!-- Menu -->
            <nav class="menu">
                <p class="menu-label">MENU</p>
                <button class="menu-item active" onclick="setActiveMenu(this)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>VISÃO GERAL</span>
                </button>
                <button class="menu-item" onclick="setActiveMenu(this)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                    </svg>
                    <span>PAROQUIANOS</span>
                </button>
                <button class="menu-item" onclick="setActiveMenu(this)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    <span>CELEBRAÇÕES</span>
                </button>
                <button class="menu-item" onclick="setActiveMenu(this)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    <span>SACRAMENTOS</span>
                </button>
                <button class="menu-item" onclick="setActiveMenu(this)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                    <span>CELEBRANTES</span>
                </button>
                <button class="menu-item" onclick="setActiveMenu(this)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    <span>DOCUMENTOS</span>
                </button>
            </nav>
            <div class="sidebar-footer">
                <button class="logout-btn" id="logout-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    <span>Terminar sessão</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div>
                    <h2>Visão Geral</h2>
                    <p>Painel / Visão Geral</p>
                </div>
                <div class="top-actions">
                    <button class="notif-button" id="notif-toggle" type="button" aria-label="Notificações">
                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"/>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                        </svg>
                        <span id="notif-badge" class="notif-badge hidden"></span>
                    </button>
                    <div id="notif-panel" class="notif-panel hidden">
                        <div class="notif-header">
                            <span>Notificações</span>
                            <button type="button" class="link-btn" id="notif-clear">Limpar</button>
                        </div>
                        <div id="notif-list" class="notif-list">
                            <p class="notif-empty">Sem notificações.</p>
                        </div>
                    </div>
                    <div class="user-info">
                        <div class="user-avatar" id="user-avatar">--</div>
                        <span id="user-name">Utilizador</span>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- VISTA DASHBOARD (CONTEÚDO ORIGINAL) -->
                <div id="dashboard-view">
                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card stat-card-black">
                            <div class="stat-content">
                                <div>
                                    <p class="stat-label">Paroquianos</p>
                                    <h3 class="stat-value" id="stat-paroquianos">0</h3>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="stat-icon">
                                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                            </div>
                        </div>

                        <div class="stat-card stat-card-white">
                            <div class="stat-content">
                                <div>
                                    <p class="stat-label">Celebrações</p>
                                    <h3 class="stat-value" id="stat-celebracoes">0</h3>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="stat-icon">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                            </div>
                        </div>

                        <div class="stat-card stat-card-black">
                            <div class="stat-content">
                                <div>
                                    <p class="stat-label">Sacramentos</p>
                                    <h3 class="stat-value" id="stat-sacramentos">0</h3>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="stat-icon">
                                    <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
                                </svg>
                            </div>
                        </div>

                        <div class="stat-card stat-card-white">
                            <div class="stat-content">
                                <div>
                                    <p class="stat-label">Celebrantes</p>
                                    <h3 class="stat-value" id="stat-celebrantes">0</h3>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="stat-icon">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                    <circle cx="9" cy="7" r="4"/>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Tables Grid -->
                    <div class="tables-grid">
                        <!-- Paroquianos Recentes -->
                        <div class="table-card">
                            <div class="table-header">
                                <h3>PAROQUIANOS RECENTES</h3>
                                <button class="btn-primary" onclick="abrirModal('paroquiano')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    Adicionar
                                </button>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th style="white-space: nowrap;">Data Nascimento</th>
                                            <th>Contacto</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-paroquianos">
                                        <!-- Preenchido via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Aniversariantes do Mês -->
                        <div class="table-card">
                            <div class="table-header">
                                <h3>ANIVERSARIANTES DO MÊS</h3>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Dia</th>
                                            <th>Nome</th>
                                            <th>Idade</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-aniversariantes">
                                        <!-- Preenchido via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Próximas Celebrações -->
                        <div class="table-card">
                            <div class="table-header">
                                <h3>PRÓXIMAS CELEBRAÇÕES</h3>
                                <button class="btn-primary" onclick="abrirModal('celebracao')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    Adicionar
                                </button>
                            </div>
                            <div class="eventos-container" id="celebracoes-container">
                                <!-- Preenchido via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VISTA GESTÃO DE CELEBRAÇÕES (SPA) -->
                <div id="celebracoes-view" style="display: none;">
                    <div class="tables-grid">
                        <!-- Formulário Nova Celebração -->
                        <div class="table-card">
                            <div class="table-header">
                                <h3>NOVA CELEBRAÇÃO</h3>
                            </div>
                            <div class="table-container form-new-celebration">
                                <form id="form-nova-celebracao" onsubmit="criarCelebracao(event)">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label for="nova-celebracao-data">Data *</label>
                                            <input type="date" id="nova-celebracao-data" required>
                                        </div>

                                        <div class="form-group">
                                            <label for="nova-celebracao-hora">Hora *</label>
                                            <input type="time" id="nova-celebracao-hora" required>
                                        </div>

                                        <div class="form-group">
                                            <label for="nova-celebracao-tipo">Tipo *</label>
                                            <input type="text" id="nova-celebracao-tipo" required>
                                        </div>

                                        <div class="form-group">
                                            <label for="nova-celebracao-celebrante">Celebrante *</label>
                                            <select id="nova-celebracao-celebrante" required>
                                                <!-- Preenchido via JS -->
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label for="nova-celebracao-local">Local</label>
                                            <input type="text" id="nova-celebracao-local" placeholder="Igreja Matriz, Capela X, ..." required>
                                        </div>
                                    </div>

                                    <div class="form-actions">
                                        <button type="submit" class="btn-primary">
                                            Guardar Celebração
                                        </button>
                                    </div>
                                </form>
                                <div id="disponibilidade-msg" class="mensagens-disponibilidade"></div>
                                <!-- Mensagens de erro / sucesso -->
                                <div id="celebracoes-mensagens" class="mensagens-celebracoes"></div>
                            </div>
                        </div>

                        <!-- Lista de Próximas Celebrações (Vista de Gestão) -->
                        <div class="table-card">
                            <div class="table-header">
                                <h3>PRÓXIMAS CELEBRAÇÕES</h3>
                                <button type="button" class="filter-toggle" onclick="toggleFiltroCelebracoes(event)">
                                    Filtrar 
                                    <img src="Images/filter.svg" alt="Editar">
                                </button>
                            </div>

                            <div id="filtro-celebracoes-menu" class="filter-menu hidden">
                                <div class="filter-row">
                                    <label for="filtro-celebrante">Celebrante</label>
                                    <select id="filtro-celebrante">
                                        <option value="">Todos</option>
                                    </select>
                                </div>
                                <div class="filter-row">
                                    <label for="filtro-tipo">Celebração</label>
                                    <input type="text" id="filtro-tipo" placeholder="Missa, batismo, casamento...">
                                </div>
                                <div class="filter-actions">
                                    <button type="button" class="btn-secondary" onclick="limparFiltroCelebracoes()">Limpar</button>
                                    <button type="button" class="btn-primary" onclick="aplicarFiltroCelebracoes()">Aplicar</button>
                                </div>
                            </div>
                            <div class="eventos-container" id="celebracoes-container-gerir">
                                <!-- Preenchido via JavaScript -->
                            </div>
                            <div id="confirm-dialog" class="modal confirm-modal hidden">
                                <div class="modal-content">
                                    <h2>Confirmar ação</h2>
                                    <p id="confirm-dialog-message"></p>
                                    <div class="confirm-actions">
                                        <button type="button" class="btn-secondary" id="confirm-dialog-cancel">Cancelar</button>
                                        <button type="button" class="btn-danger" id="confirm-dialog-ok">Remover</button>
                                    </div>
                                </div>
                            </div>
                            <div id="modal-editar" class="modal hidden">
                                <div class="modal-content">
                                    <h2>Editar Celebração</h2>

                                    <form id="form-editar-celebracao">
                                        <div class="form-group">
                                            <label>Data:</label>
                                            <input type="date" id="edit-data">
                                        </div>
                                        <div class="form-group">
                                            <label>Hora:</label>
                                            <input type="time" id="edit-hora">
                                        </div>
                                        <div class="form-group">
                                            <label>Tipo:</label>
                                            <input type="text" id="edit-tipo">
                                        </div>
                                        <div class="form-group">
                                            <label>Celebrante:</label>
                                            <select id="edit-celebrante"></select>
                                        </div>
                                        <div class="form-group">
                                            <label>Local:</label>
                                            <input type="text" id="edit-local">
                                        </div>
                                        <div id="editar-disponibilidade-msg"></div>
                                        <div id="confirmacao-panel" class="confirmacao-panel hidden">
                                            <div class="confirmacao-status">
                                                <span>Confirmação do celebrante:</span>
                                                <span id="confirmacao-estado-label" class="evento-badge evento-badge-estado"></span>
                                            </div>
                                            <div class="confirmacao-actions">
                                                <button type="button" class="btn-secondary" onclick="pedirConfirmacaoCelebrante()">Pedir confirmação</button>
                                                <button type="button" class="btn-primary" onclick="marcarConfirmacaoCelebrante('confirmado')">Marcar confirmado</button>
                                                <button type="button" class="btn-secondary" onclick="marcarConfirmacaoCelebrante('pendente')">Marcar pendente</button>
                                            </div>
                                            <div id="confirmacao-msg" class="mensagens-disponibilidade"></div>
                                        </div>
                                        <div class="form-actions">
                                            <button type="submit" class="btn-primary">Guardar alterações</button>
                                            <button type="button" onclick="fecharModalEditar()" class="btn-primary">Cancelar</button>
                                        </div>

                                        
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- fim .content-area -->
        </div>
    </div>

    <script src="js/app.core.js"></script>
    <script src="js/app.notifications.js"></script>
    <script src="js/app.disponibilidade.js"></script>
    <script src="js/app.editar.js"></script>
</body>
</html>
